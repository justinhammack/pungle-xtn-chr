<html>
  <script src="scripts/classes.js" type="text/javascript"></script>
  <script src="scripts/functions.js" type="text/javascript"></script>
  <script>
  
  // Copyright 2011 Pungle, LLC All Rights Reserved.
  
  /*
  * Description: Background code for extension, dependent on content of tabs.
  * Author: note@pungle.me (Justin Hammack)
  */
  
  
  /*
  *-------------------------------------------------------------------------------
  *
  *
  *   CLEANUP FUNCTION CALLS, REORGANIZE SO IT DOESN'T SEEM SO BLATANTLY RIPPED 
  *   find all: // <-- wtf does this do? 
  *
  *
  *-------------------------------------------------------------------------------
  */
  
  
  /*
  *----------------------------------
  * Global Variables & Environment
  *----------------------------------
  */  
  var pXtn = new pungleExtension(); // load pungle extension object
  var VERSION = "1.0.0"; // major.minor.build 
  var portMap = new Array(); // <-- wtf does this do? 
  var clickStream = new Array(); // <-- wtf does this? 
  
  // Setup localStorage.
  log("VERSION: " + getItem("ltvid")); // <--- do we need this vintage cause/plugin bullshit, ltvid?
  log("Loading Pungle Extension: v" + VERSION);
  log("Setup Environment");
  setItemIfNotExists("version", VERSION);
  setItemIfNotExists("lastUpdHash", "0000-00-00"); // <-- wtf does this do? 
  setItemIfNotExists("readonly", "0"); // <-- wtf does this do? 
  setItemIfNotExists("btnviews", "0"); // <-- wtf does this do? 
  setItemIfNotExists("num_accepts", "0"); // <-- wtf does this do? 
  setItemIfNotExists("num_declines", "0"); // <-- wtf does this do? 
  setItemIfNotExists("plugin_type", "gc-slider"); // <-- wtf does this do? 
  
  // Global variables declared from localStorage.
  var __plugin_type = getItem("plugin_type"); // <-- wtf does this do? 
  var READ_ONLY = getItem("readonly"); // <-- wtf does this do? 
  
  // Check merchant list.
  pXtn.updateMerchantHash(); // <-- wtf does this do? 
  
  // Adds trim method to string.
  String.prototype.trim = function() { return this.replace(/^\s+|\s+$/g,""); }
  

  /*
  *----------------------------------------------
  *   Create Open Connection to Content Script
  *
  *   msg.query =?
  *     isRedirect
  *     send or requestSend 
  *   
  *   msg.action =? updatesubDom
  *----------------------------------------------
  */
  chrome.extension.onConnect.addListener(function (port) {
    console.assert(port.name == "punglePort"); // test if content script can be found 
    
    // listen for incoming content script messages
    port.onMessage.addListener(function (msg) {
      if (msg.query == 'isRedirect') { // <-- wtf does this do? 
        log("Mesage isRedirect recieved! --" + cleanURL(msg.url));
        var flag = WCR.isRedirect(cleanURL(msg.url));
        portMap[cleanURL(msg.url)] = port;
        
        if (flag && !WCR.hasSliderFired(cleanURL(msg.url))) { // <-- wtf does this do? 
          log("Sending Redirect Message " + msg.url);
          var clean = cleanURL(msg.url);
          WCR.sliderFired(clean);
          
          var merchantName = WCR.getMerchantName(clean);
          log(" Sending  " + merchantName);
          
          var couponStr = WCR.getMerchantCoupon(clean);
          log("Got " + merchantName + " - > " + couponStr);
          
          var logoURL = WCR.getLogoURL();
          
          port.postMessage({ // <-- wtf does this do? 
            response: "redirect",
            merchant: merchantName,
            logo: logoURL,
            subdom: getItem("subdomain"),
            causeName: WCR.getCauseName(),
            earn: WCR.isEarnDonation(clean),
            coupon: couponStr
          });
        }
      } else if (msg.query == "send" || msg.query == "requestSend") { // <-- wtf does this do? 
        var url = msg.url;
        url = removeWWW(cleanURL(url));
        wcr_to = WCR.getMerchant(url);
        log("Message " + msg.query + "  " + url + "  Merchant " + wcr_to);
        
        if ((msg.query == "requestSend" && !WCR.isEarnDonation(url)) || msg.query == "send") { // <-- wtf does this do? 
          var redirectURL = WCR.sendInformation(wcr_to, true);
          log("Redirect URL " + redirectURL);
          
          port.postMessage({
            response: 'inject',
            url: redirectURL
          });
        } else { // <-- wtf does this do? 
          log("Earn donation required on " + url);
        }
      } else if (msg.action == "updateSubdom") { // <-- wtf does this do? 
        if (READ_ONLY == 0 || getItem("subdomain") == "") { // <-- wtf does this do? 
          var sessionSubdom = msg.session;
          var causeName = msg.cause;
          
          //test for session and cause name
          log("Recieved Update Message From Slider " + sessionSubdom + " -- " + causeName);
          WCR.setCauseName(causeName);
          WCR.setSubdomain(sessionSubdom);
          WCR.cacheImage(WCR.getLogoURL());
        }
      }
    }); // end of incoming port message listener 
  }); // end of content script listener
  
  
  /* 
  *----------------------------
  *   Listen for Tab Updates
  *----------------------------
  */
  chrome.tabs.onUpdated.addListener(function (tabid, changeInfo, tab) {
    thisURL = changeInfo.url;
    //log("Tab: " + tabid + " --> "+thisURL + " --> " + changeInfo.status);
    //start creating the click stream for this tab.
    if (typeof (clickStream[tabid]) == "undefined") {
      clickStream[tabid] = new PTUWatch(tabid);
    }
  
    //Did we hit we-care?
    if (typeof (thisURL) != "undefined") {
      var redirectURL = "";
      if (thisURL.search('/Redirect/Store/') != -1) {
        var pos = thisURL.indexOf('/Redirect/Store/');
        pos += 16;
        var len = thisURL.length;
        var merchant = thisURL.substr(pos, (len - pos));
        if (merchant.indexOf("?") > 0) merchant = merchant.split("?")[0];
        log("We-Care Redirect Page " + merchant);
        WCR.flagWeCareRedirect(merchant);
      }
    }
  
    thisURL = cleanURL(thisURL);
    //add this url to the click stream
    if (typeof (changeInfo.url) != "undefined") clickStream[tabid].appendClick(changeInfo.url);
  
    var redirect = false;
    var wcr_to = "";
    //are we on a merchant?
    if (WCR.exists(thisURL) && !WCR.wasVisited(removeWWW(thisURL))) {
      redirect = true;
      WCR.setVisited(thisURL);
      WCR.setVisited(removeWWW(thisURL));
      wcr_to = WCR.getMerchant(thisURL);
      if (WCR.isRedirectFlagged(wcr_to)) {
        redirect = false;
      }
    }
  
    if (clickStream[tabid].isClickThru()) {
      redirect = false;
      //if the URL exists as a merchant and we have identified a clickthru,
      //then clear the current stream to setup for the next round of requests.
      if (typeof (thisURL) != "undefined" && WCR.exists(thisURL)) {
        WCR.flagWeCareRedirect(WCR.getMerchant(thisURL));
        clickStream[tabid].clearStream();
      }
    } //end if ClickThru
    if (changeInfo.status == "complete") {
      if (!clickStream[tabid].isClickThru()) {
        var url = cleanURL(tab.url);
        if (WCR.hasSliderFired(url)) {
          log("BG-Complete:: Slider was fired. " + url);
        }
        else {
          if (WCR.isRedirect(url) || WCR.isRedirect(removeWWW(url))) {
            log("BG-Complete:: Slider has not fired for " + url + "  -- doing so now.");
            if (portMap[url]) {
              var port = portMap[url];
              sendRedirectMessage(port, url);
            }
          }
        }
      }
      else {
        log("Found ClickThru In Stream!");
      }
      return; // to event dispatcher. No need to process any further.
    } //end if status = 'complete'
    if (typeof (thisURL) == "undefined" || thisURL.toString().indexOf("chrome://") != -1) {
      return; //to event dispatcher.  No URL
    }
  
    //check for affilate clickthru tags
    checkURL = changeInfo.url;
    checkURL = checkURL.toLowerCase();
    if (checkURL.match(".*affsrc=.*") || checkURL.match(".*aff=.*") || checkURL.match(".*afsrc=.*") || checkURL.match(".*amazon.com.*tag=.*")) {
      redirect = false;
      log("Found ClickThru, not redirecting.");
    }
  
    //Send Redirect Information
    if (changeInfo.status == "loading" && redirect) {
      clickStream[tabid].clearStream();
      log("BG:: Setting " + thisURL + " redirect true");
      WCR.setRedirect(thisURL, true);
    }
  });


  /* React to extension uninstall.
  chrome.management.onUninstalled.addListener(function(id) {
    if(id == ''){
      var redirectUrl = "http://pungle.me/uninstall-survey/";
      chrome.tabs.create({url:redirectUrl, selected:true});
    }
  }); */
  
  </script>
</html>