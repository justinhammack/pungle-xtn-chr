<html>
  <script src="scripts/classes.js" type="text/javascript"></script>
  <script src="scripts/functions.js" type="text/javascript"></script>
  <!-- <script src="http://pungle.me/core/pungleJSON.js" type="text/javascript"></script> -->
  <script src="http://localhost/core/pungleJSON.js" type="text/javascript"></script>
  <script>
  
  // Copyright 2011 Pungle, LLC. All Rights Reserved.
  
  /*
  *-----------------------------------------------------------------------------
  * Description: Handles affiliate referrals transparently for user.
  * Author: note@pungle.me (Justin Hammack)
  *-----------------------------------------------------------------------------
  */
  
  
  /*
  *-----------------------------------------------------------------------------
  *
  *
  *   CLEANUP FUNCTION CALLS, REORGANIZE SO IT DOESN'T SEEM SO BLATANTLY RIPPED 
  *   find all: // <-- wtf does this do? 
  *
  *
  *-----------------------------------------------------------------------------
  */
  
  
  /*
  *-----------------------------------------------------------------------------
  * Global Variables & Environment
  *-----------------------------------------------------------------------------
  */  
  var pXtn = new pungleExtension(); // Load pungle extension object.
  var VERSION = queryVersion(); // major.minor.build 
  var listenerBridge = new Array(); // Tracks the URL between messenger & tab listeners.
  var tabMonitor = new Array(); // Array of tab ids by url mapped to PTUWatch class.
  
  // Setup localStorage.
  // log("VERSION: " + getItem("ltvid")); // <--- do we need this vintage cause/plugin bullshit, ltvid?
  log("Loading Pungle Extension: v" + VERSION);
  log("Setup Environment");
  
  setIfEmpty("version", VERSION); // track version
  
  // setItemIfEmpty("lastUpdHash", "0000-00-00"); // stores query local, don't need to poll for new stores
  // setItemIfEmpty("readonly", "0"); // <-- is the cause json file writable?
  // setItemIfEmpty("btnviews", "0"); // <-- counts number of button views for stores
  // setItemIfEmpty("num_accepts", "0"); // <-- counts if they accept
  // setItemIfEmpty("num_declines", "0"); // <-- counts if they decline
  
  // Global variables declared from localStorage.
  // var READ_ONLY = getItem("readonly"); // <-- wtf does this do? 
  
  // Check merchant list.
  // pXtn.updateMerchantHash(); // <-- wtf does this do? 
  
  // Adds trim method to string.
  String.prototype.trim = function() { return this.replace(/^\s+|\s+$/g,""); }
  

  /*
  *-----------------------------------------------------------------------------
  * Create Open Connection to Content Script
  *   1) If request to check for redirect?
  *   2) Else if request received to send aff link.
  *   3) Require user interaction? 
  *   4) User request to update cause? 
  *-----------------------------------------------------------------------------
  */
  chrome.extension.onConnect.addListener(function (port) {
    console.assert(port.name == "punglePort"); // test if content script can be found 
    
    // listen for incoming content script messages
    port.onMessage.addListener(function (msg) {
      if (msg.query == 'isRedirect') { 
        // Redirect has been requested by the content script.
        
        log("Mesage Received: " + msg.query);
        log("From Tab URL: " + cleanURL(msg.url));
        
        // Check to see if redirect called.
        var flag = WCR.isRedirect(cleanURL(msg.url));
        
        // Establish listener bridge for tab.onUpdated.
        listenerBridge[cleanURL(msg.url)] = port;
        
        if (flag && !pXtn.hasRedirectRun(cleanURL(msg.url))) { 
          // Check to make sure redirect called & it hasn't already run.
          
          log("Sending Redirect Message " + msg.url);
          var clean = cleanURL(msg.url);
          pXtn.redirectRun(clean);
          
          var merchantName = WCR.getMerchantName(clean);
          log(" Sending  " + merchantName);
          
          var couponStr = WCR.getMerchantCoupon(clean);
          log("Got " + merchantName + " - > " + couponStr);
          
          var logoURL = WCR.getLogoURL();
          
          port.postMessage({ // <-- wtf does this do? 
            response: "redirect",
            merchant: merchantName,
            // logo: logoURL,
            // subdom: getItem("subdomain"),
            cause: pXtn.getCauseName()
            // earn: WCR.isEarnDonation(clean), // <-- require high five?
            // coupon: couponStr
          });
        }
      } else if (msg.query == "send" || msg.query == "requestSend") { 
        // Prepare to send the content script the affiliate link.
        
        var url = msg.url;
        url = removeWWW(cleanURL(url));
        wcr_to = WCR.getMerchant(url);
        log("Message " + msg.query + "  " + url + "  Merchant " + wcr_to);
        
        if ((msg.query == "requestSend" && !WCR.isEarnDonation(url)) || msg.query == "send") { 
          // Allow automatic injection of referral link.
          
          var redirectURL = pXtn.affiliateLink(wcr_to, true);
          log("Sending Redirect URL: " + redirectURL);
          
          port.postMessage({
            response: 'inject',
            url: redirectURL
          });
        } else { 
          // Require user interaction.
          
          log("User action required at: " + url);
        }
      } /* else if (msg.action == "updateSubdom") { // <-- to update cause thinger
        if (READ_ONLY == 0 || getItem("subdomain") == "") {
          var sessionSubdom = msg.session;
          var causeName = msg.cause;
          
          //test for session and cause name
          log("Recieved Update Message From Slider " + sessionSubdom + " -- " + causeName);
          WCR.setCauseName(causeName);
          WCR.setSubdomain(sessionSubdom);
          WCR.cacheImage(WCR.getLogoURL());
        }
      } */
    }); // end of port messenger listener 
  }); // end of onconnect listener
  
  
  /* 
  *-----------------------------------------------------------------------------
  * Listen for Tab Updates
  *   1) Verify Tab URL is monitored.
  *   2) Check if referral from Pungle.me.
  *   3) Check if should redirect.
  *   4) Call redirect if true.
  *-----------------------------------------------------------------------------
  */
  chrome.tabs.onUpdated.addListener(function (tabid, changeInfo, tab) {
    thisURL = changeInfo.url;
    log("Tab Updated => ID: " + tabid + " " + changeInfo.status);
    log("Tab Updated => URL: " + thisURL);
    // log("Tab Status: " + changeInfo.status);
    
    // create new monitor if does not exist
    if (typeof (tabMonitor[tabid]) == "undefined") {
      tabMonitor[tabid] = new PTUWatch(tabid);
      log("Created New Tab Monitor");
    } else log("Tab Monitor Exists");
    
    // where are we? pungle referral? prevents redirect capture
    /* if (typeof (thisURL) != "undefined") {
      // valid url?
      
      var redirectURL = ""; // initialize variable
      
      if (thisURL.search('/Redirect/Store/') != -1) {
        var pos = thisURL.indexOf('/Redirect/Store/');
        pos += 16;
        var len = thisURL.length;
        var merchant = thisURL.substr(pos, (len - pos));
        if (merchant.indexOf("?") > 0) merchant = merchant.split("?")[0];
        log("We-Care Redirect Page " + merchant);
        WCR.flagWeCareRedirect(merchant);
      }
    } */
    
    thisURL = cleanURL(thisURL); // Clean off url protocol & path.
    
    // Attach record of this URL to the Tab Monitor for reference.
    if (typeof (changeInfo.url) != "undefined") tabMonitor[tabid].appendClick(changeInfo.url);
    
    var redirect = false; // Should we redirect? (assume false)
    var pXtn_dest = ""; // What store are we going to?
    
    // Are we on a merchant page? 
    if ( pXtn.exists(thisURL) && !pXtn.wasVisited(removeWWW(thisURL)) ) {
      // We must redirect, first time visit.
      
      redirect = true;
      
      // Set as visited for session reference.
      pXtn.setVisited(thisURL);
      pXtn.setVisited(removeWWW(thisURL));
      
      // Get the merchant name. Change to get Merchant ID?? 
      pXtn_dest = pXtn.getMerchant(thisURL);
      
      if (pXtn.isRedirectFlagged(pXtn_dest)) {
        // Check to see if we came from pungle, if so, don't redirect.
        redirect = false;
      }
    }
    
    /* Checks to see if user came from other affiliate, but code is inferior.
    if (tabMonitor[tabid].isClickThru()) {
      redirect = false;
      //if the URL exists as a merchant and we have identified a clickthru,
      //then clear the current stream to setup for the next round of requests.
      if (typeof (thisURL) != "undefined" && WCR.exists(thisURL)) {
        WCR.flagWeCareRedirect(WCR.getMerchant(thisURL));
        tabMonitor[tabid].clearStream();
      }
    } //end if ClickThru */
    
    // Check if Tab URL has completed loading.
    if (changeInfo.status == "complete") {
      log("Found tab with page loaded.");
      
      /* if (!tabMonitor[tabid].isClickThru()) { NO LONGER CHECK FOR AFF REF */
      
      // Set to the tab's loaded URL.
      var tabUrl = cleanURL(tab.url);
      
      if (pXtn.hasRedirectRun(tabUrl)) {
        log("Extension => Redirect has run for: " + tabUrl);
      } else {
        if (pXtn.isRedirect(tabUrl) || pXtn.isRedirect(removeWWW(tabUrl))) {
          log("Extension => Redirect has not run for: " + tabUrl);          
          if (listenerBridge[tabUrl]) {
            // Set port when bridge found in array.
            var port = listenerBridge[tabUrl];
            
            log("Listener bridge established.");
            
            // Send redirect message to content script.
            sendRedirectMessage(port, tabUrl);
          }
        }
      }
      /* CONTINUE.. NO LONGER CHECK FOR AFF REF 
      else {
        log("Found ClickThru In Stream!");
      } */
      
      return; // to event dispatcher. No need to process any further.
    } // end if status = 'complete'
    
    if (typeof (thisURL) == "undefined" || thisURL.toString().indexOf("chrome://") != -1) {
      return; //to event dispatcher.  No URL
    }
    
    //check for affilate clickthru tags
    /* checkURL = changeInfo.url;
    checkURL = checkURL.toLowerCase();
    if (checkURL.match(".*affsrc=.*") || checkURL.match(".*aff=.*") || checkURL.match(".*afsrc=.*") || checkURL.match(".*amazon.com.*tag=.*")) {
      redirect = false;
      log("Found ClickThru, not redirecting.");
    } */
    
    // Cleared all conditions, que URL to be redirected.
    if (changeInfo.status == "loading" && redirect) {
      tabMonitor[tabid].clearStream();
      log("Extension => Set Redirect True: " + thisURL);
      pXtn.setRedirect(thisURL, true);
    }
  });


  /* React to extension uninstall.
  chrome.management.onUninstalled.addListener(function(id) {
    if(id == ''){
      var redirectUrl = "http://pungle.me/uninstall-survey/";
      chrome.tabs.create({url:redirectUrl, selected:true});
    }
  }); */
  
  </script>
</html>